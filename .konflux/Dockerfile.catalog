# The opm image is expected to contain /bin/opm (with a serve subcommand) and /bin/grpc_health_probe
ARG OPM_IMAGE=registry.redhat.io/openshift4/ose-operator-registry:v4.12
ARG BUILDER_IMAGE=brew.registry.redhat.io/rh-osbs/openshift-golang-builder:rhel_8_golang_1.17

# fix the catalog (talm exclusive, naming issue)
FROM ${BUILDER_IMAGE} AS builder

# create dir structure to fix the catalog
RUN mkdir -p /app/.konflux/catalog
COPY Makefile /app
COPY .konflux/catalog/ /app/.konflux/catalog/
# we need to copy the vendor/ folder as the Makefile depends on it
COPY vendor/ /app/vendor/

WORKDIR /app
RUN SKIP_SUBMODULE_SYNC=yes make konflux-fix-catalog-name

# run the catalog
FROM ${OPM_IMAGE}

ENTRYPOINT ["/bin/opm"]
CMD ["serve", "/configs", "--cache-dir=/tmp/cache"]

# ensure this correponds to olm.package name
ENV PACKAGE_NAME=topology-aware-lifecycle-manager

# This assumes that the catalog is already built and exists in the .konflux/catalog/$PACKAGE_NAME directory
# This should be done automatically by the fbc pipeline using the `run-opm-command` task
COPY --from=builder /app/.konflux/catalog/$PACKAGE_NAME/ /configs/$PACKAGE_NAME
# RUN ["/bin/opm", "validate", "/configs/topology-aware-lifecycle-manager"]
RUN ["/bin/opm", "serve", "/configs", "--cache-dir=/tmp/cache", "--cache-only"]

LABEL operators.operatorframework.io.index.configs.v1=/configs
